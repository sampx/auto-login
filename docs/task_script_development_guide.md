# 任务脚本开发指南

欢迎使用通用任务调度引擎! 本指南旨在帮助您快速、规范地开发可被本调度引擎执行的任务脚本,无论您使用 Python 还是 Shell。

遵循本指南将确保您的任务能够与引擎高效协同,并充分利用引擎提供的日志管理、状态监控和智能重试等高级功能。

---

## 核心开发约定 (通用)

以下三条是所有类型任务脚本都必须遵守的核心约定。

### 1. 日志处理: 使用标准输出

**规则**: 任务脚本不应自行处理日志文件。所有需要记录的信息,都应该直接打印到**标准输出 (`stdout`)** 或 **标准错误 (`stderr`)**。

- **正常信息/调试信息**: 输出到 `stdout`。
- **错误信息/警告信息**: 输出到 `stderr`。

调度引擎会自动捕获这两种输出,并将其写入为该任务配置的日志文件中,同时实现日志的自动回转和清理。

### 2. 退出码规范: 明确任务的最终状态

**规则**: 脚本执行结束时,必须通过退出码 (Exit Code) 明确告知引擎其最终状态。这是实现智能重试和精确状态监控的关键。

- `exit 0`: **执行成功 (Success)**
  - **含义**: 任务的技术流程和业务目标均已成功达成。
  - **引擎行为**: 记录为“成功”, **不会**进行重试。

- `exit 1`: **业务失败 (Business Failure)**
  - **含义**: 脚本本身运行正常,未发生技术异常,但预期的业务目标未能达成。这是一种**可预期的失败**。
  - **示例**: 尝试登录但密码错误、抓取数据但目标页面无所需信息、处理文件但文件不符合业务规范。
  - **引擎行为**: 记录为“业务失败”, **不会**进行重试。

- `exit 2`: **技术失败 (Technical Failure)**
  - **含义**: 脚本在执行过程中遇到了非预期的技术问题,导致无法继续执行。
  - **示例**: 数据库连接失败、网络请求超时、代码抛出未捕获的异常、依赖的服务不可用。
  - **引擎行为**: 记录为“技术失败”, **会**根据任务配置的重试策略进行重试。

### 3. 环境变量: 获取任务上下文信息

**规则**: 调度引擎会通过环境变量向任务脚本传递一些有用的上下文信息。

- **标准环境变量**:
  - `TASK_ID`: 当前执行的任务的唯一 ID。

- **自定义环境变量**:
  - 您在任务配置的 `task_env` 字段中定义的任何键值对,都会被注入到脚本的运行环境中。

---

## Python 脚本实现示例

```python
import sys
import os

# --- 日志 ---
print("这是一条常规日志信息,将被记录到任务日志中。")
sys.stderr.write("这是一条错误信息,同样会被记录。\n")

# --- 环境变量 ---
task_id = os.environ.get('TASK_ID', 'unknown')
api_key = os.environ.get('API_KEY', '未提供')
print(f"任务ID: {task_id}, API_KEY: {api_key}")

# --- 退出码 ---
mode = "success" # or "business_failure" or "technical_failure"
if mode == "success":
    sys.exit(0)
elif mode == "business_failure":
    sys.exit(1)
else:
    sys.exit(2)
```

---

## Shell 脚本实现示例

```bash
#!/bin/bash

# --- 日志 ---
# 输出到 stdout
echo "这是一条常规日志信息,将被记录到任务日志中。"

# 输出到 stderr
echo "这是一条错误信息,同样会被记录。" >&2

# --- 环境变量 ---
# 使用 ${VAR_NAME:-"default_value"} 提供默认值
echo "任务ID: ${TASK_ID:-"unknown"}"
echo "API_KEY: ${API_KEY:-"未提供"}"

# --- 退出码 ---
MODE="success" # or "business_failure" or "technical_failure"

if [ "$MODE" == "success" ]; then
  echo "任务圆满完成!"
  exit 0
elif [ "$MODE" == "business_failure" ]; then
  echo "业务失败: 未找到指定数据。" >&2
  exit 1
else
  echo "技术失败: 无法连接到数据库。" >&2
  exit 2
fi
```

遵循以上约定,您就可以开发出健壮、可靠且易于维护的任务脚本。祝您编码愉快!